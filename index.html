<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ë©€í‹° í¬ì»¤ ì¹© íŒ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            background: #1e1e1e;
            color: white;
            font-family: sans-serif;
            text-align: center;
            padding-bottom: 140px;
        }

        /* ìƒë‹¨ ì •ë³´ ì˜ì—­ */
        #round {
            font-size: 22px;
            color: #1abc9c;
            margin-top: 15px;
            font-weight: bold;
        }

        #phase {
            font-size: 16px;
            color: #16a085;
            margin-bottom: 20px;
        }

        .initial-setup {
            margin-bottom: 30px;
            padding: 15px;
            background: #333;
            border-radius: 10px;
            display: inline-flex;
            gap: 10px;
        }

        /* í”Œë ˆì´ì–´ ì¹´ë“œ ë°°ì¹˜ */
        .players {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            padding: 10px;
        }

        .player {
            width: 320px;
            background: #2b2b2b;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #444;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        /* í”Œë ˆì´ì–´ ì‚­ì œ ë²„íŠ¼ (x) */
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 12px;
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            line-height: 1;
            padding: 5px;
            transition: color 0.2s;
        }

        .remove-btn:hover {
            color: #e74c3c;
        }

        .player.folded {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .player.debt {
            border-color: #e74c3c;
        }

        .player h3 {
            color: #f1c40f;
            margin: 0 0 15px 0;
            cursor: pointer;
        }

        .bet-info {
            font-size: 14px;
            color: #aaa;
            margin: 2px 0;
        }

        .chips {
            font-size: 32px;
            margin: 15px 0;
            font-weight: bold;
        }

        /* â­ ì¹© ë²„íŠ¼: í¬ê¸° ê³ ì • ë° ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
        .chip-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .chip-btn {
            width: 55px !important;
            height: 55px !important;
            /* í¬ê¸° ê°•ì œ ê³ ì • */
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-weight: bold;
            flex-shrink: 0;
            /* ì ˆëŒ€ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.2);
        }

        /* 1. ì¹© ë²„íŠ¼ ìˆ«ì ìƒ‰ìƒ ë° ì•„ì´í° ìë™ ë§í¬ ë°©ì§€ */
        .chip-1 {
            background: #95a5a6 !important;
            color: #1e1e1e !important;
            /* ê¸€ììƒ‰ ê²€ì • ê³ ì • */
            text-decoration: none !important;
        }

        .chip-5 {
            background: #e74c3c;
            color: white;
        }

        .chip-10 {
            background: #3498db;
            color: white;
        }

        .chip-25 {
            background: #27ae60;
            color: white;
        }

        /* 2. í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ (ê²¹ì¹¨ì˜ í•µì‹¬ ì›ì¸ í•´ê²°) */
        .action-buttons {
            display: flex;
            align-items: center;
            /* ì¤‘ì•™ ì •ë ¬ */
            justify-content: space-between;
            gap: 5px;
            /* ê°„ê²©ì„ ì¢í˜€ì„œ ê³µê°„ í™•ë³´ */
            height: 100px;
            /* ë†’ì´ë¥¼ ì¶©ë¶„íˆ í™•ë³´ */
        }

        /* ë‹¤ì´, ì˜¬ì¸ ë²„íŠ¼ í¬ê¸° ìµœì í™” */
        .action-btn-rect {
            width: 50px !important;
            /* ê°€ë¡œí­ì„ ì¤„ì—¬ì„œ ì…ë ¥ì°½ ê³µê°„ í™•ë³´ */
            height: 85px !important;
            /* ë†’ì´ëŠ” ìœ ì§€ */
            border-radius: 8px;
            border: none;
            font-weight: bold;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            /* ì ˆëŒ€ ì°Œê·¸ëŸ¬ì§€ì§€ ì•ŠìŒ */
            font-size: 13px;
        }

        .fold {
            background: #555;
        }

        .allin {
            background: #c0392b;
        }

        /* 3. ê°€ìš´ë° ì…ë ¥ì°½ ê·¸ë£¹ (ë² íŒ…/ëŒ€ì¶œ ì¹¸) */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 110px;
            /* ì¤‘ìš”: ë¶€ëª¨ë¥¼ ëš«ê³  ë‚˜ê°€ì§€ ì•Šê²Œ ë°©ì§€ */
        }

        .custom-input {
            width: 100%;
            height: 36px;
            border-radius: 6px;
            border: none;
            text-align: center;
            font-size: 13px;
            background: #eeeeee;
            color: #000;
            /* iOS ë‘¥ê·¼ ëª¨ì„œë¦¬ ë°©ì§€ */
        }

        /* ì¶”ê°€: ì•¡ì…˜ ë²„íŠ¼ë“¤ì´ ë„ˆë¬´ ë†’ê²Œ ëŠê»´ì§„ë‹¤ë©´ ë†’ì´ ì‚´ì§ ì¡°ì ˆ */
        .action-buttons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            height: 80px;
            /* ê³ ì • ë†’ì´ ìœ ì§€ */
        }

        /* ë‹¨ê³„ ì´ë™ ë²„íŠ¼ */
        .next-phase-container {
            margin: 40px auto;
            width: 90%;
            max-width: 600px;
        }

        .next-phase {
            width: 100%;
            padding: 20px;
            background: #8e44ad;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        /* í•˜ë‹¨ ê³ ì • íŒŸ */
        #pot {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #111;
            padding: 20px;
            font-size: 24px;
            border-top: 2px solid #444;
            font-weight: bold;
        }

        /* ëª¨ë‹¬ */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal-content {
            background: #2b2b2b;
            padding: 30px;
            border-radius: 15px;
            width: 300px;
        }

        /* ëª¨ë°”ì¼ í™”ë©´ì´ ì•„ì£¼ ì‘ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì¶”ê°€ ë³´ì • */
        @media (max-width: 360px) {
            .player {
                width: 100%;
                /* í”Œë ˆì´ì–´ ë°•ìŠ¤ê°€ í™”ë©´ì„ ê½‰ ì±„ìš°ê²Œ */
                padding: 15px 10px;
            }

            .chip-btn {
                width: 50px !important;
                height: 50px !important;
            }
        }
    </style>
</head>

<body>

    <h1>ğŸƒ ë©€í‹° í¬ì»¤ ì¹©</h1>

    <div id="round">ë¼ìš´ë“œ: í”„ë¦¬í”Œë</div>
    <div id="phase">ë‹¨ê³„: ë² íŒ…</div>

    <div class="initial-setup">
        <input id="newPlayerName" placeholder="ë‚´ ì´ë¦„" style="padding:8px;"
            onkeydown="if(event.isComposing) return; if(event.key === 'Enter') reqAddPlayer();">

        <input id="initialChips" type="number" value="1000" style="width:60px; padding:8px;">
        <button onclick="reqAddPlayer()" style="background:#2980b9; color:white;">ì°¸ê°€</button>
    </div>
    <div class="players" id="playersContainer">
    </div>

    <div class="next-phase-container">
        <button class="next-phase" onclick="reqNextPhase()">ë‹¨ê³„ ì´ë™ (í„´ ë„˜ê¸°ê¸°)</button>
    </div>

    <div style="margin-bottom: 20px;">
        <button onclick="reqResetGame()"
            style="background: #444; color: #bbb; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; cursor: pointer;">
            ğŸ”„ ì „ì²´ ê²Œì„ ì´ˆê¸°í™” (ì¹© ë³µêµ¬)
        </button>
    </div>

    <div id="pot">POT: <span id="potAmount">0</span></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalText"></h2>
            <button class="modal-btn" onclick="reqConfirmWin()" style="background:#27ae60;">í™•ì¸</button>
            <button class="modal-btn" onclick="closeModal()" style="background:#c0392b;">ì·¨ì†Œ</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ë¸Œë¼ìš°ì €ë§ˆë‹¤ ê³ ìœ í•œ ID ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
        if (!localStorage.getItem('poker_uuid')) {
            localStorage.setItem('poker_uuid', 'user_' + Math.random().toString(36).substr(2, 9));
        }
        const MY_UUID = localStorage.getItem('poker_uuid');

        const socket = io(); // ì„œë²„ ì—°ê²°

        let currentWinnerId = null; // ìŠ¹ë¦¬ ì²˜ë¦¬ìš© ì„ì‹œ ë³€ìˆ˜

        // === ì„œë²„ë¡œë¶€í„° ë°ì´í„° ë°›ì•„ì„œ í™”ë©´ ê·¸ë¦¬ê¸° (í•µì‹¬) ===
        socket.on('updateState', (state) => {
            renderGame(state);
        });

        function renderGame(state) {
            // 1. ë¼ìš´ë“œ ë° íŒŸ ì •ë³´
            document.getElementById('round').innerText = "ë¼ìš´ë“œ: " + state.rounds[state.roundIndex];
            document.getElementById('phase').innerText = "ë‹¨ê³„: " + (state.phase === 'bet' ? 'ë² íŒ…' : 'ì¹´ë“œ í™•ì¸/ë“œë¡œìš°');
            document.getElementById('potAmount').innerText = state.pot;

            // 2. í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';

            // íˆ¬í‘œ ê³„ì‚°ì„ ìœ„í•œ ë³€ìˆ˜
            const activePlayers = state.players.filter(p => !p.folded);
            const activeCount = activePlayers.length;
            // ì‹¤ì œ ê²Œì„ ì¤‘ì¸(active) ì‚¬ëŒ ì¤‘ ì¤€ë¹„ ì™„ë£Œí•œ ì‚¬ëŒë§Œ ì¹´ìš´íŠ¸
            const readyCount = state.readyPlayers.filter(id =>
                state.players.some(p => p.id === id && !p.folded)
            ).length;

            state.players.forEach(p => {
                const pDiv = document.createElement('div');
                // socket.idê°€ ë°”ë€Œì–´ë„ UUIDê°€ ê°™ìœ¼ë©´ 'ë‚˜'ë¡œ ì¸ì‹
                const isMe = (p.id === socket.id || p.uuid === MY_UUID);
                const isReady = state.readyPlayers.includes(p.id);

                pDiv.className = `player ${p.folded ? 'folded' : ''} ${p.inDebt ? 'debt' : ''}`;

                // ì¤€ë¹„ ì™„ë£Œ ì‹œ ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ íš¨ê³¼
                if (isReady && !p.folded) {
                    pDiv.style.boxShadow = "0 0 20px #8e44ad";
                    pDiv.style.borderColor = "#8e44ad";
                }

                pDiv.innerHTML = `
            ${isMe ? `<button class="remove-btn" onclick="reqRemovePlayer('${p.id}')">Ã—</button>` : ''}
            
            <h3 onclick="${isMe ? `openWinModal('${p.id}', '${p.name}')` : ''}">
                ${p.name} ${isMe ? '(ë‚˜)' : ''} ${isReady && !p.folded ? 'âœ…' : ''}
            </h3>
            
            <div class="bet-info"><span>ë² íŒ…:</span> <span>${p.bet}</span></div>
            <div class="bet-info" style="color:#e67e22"><span>ì½œ í•„ìš”:</span> <span>${p.callNeed}</span></div>
            
            <div class="chips">${p.chips}</div>

            <div class="chip-buttons" style="${isMe ? '' : 'pointer-events: none; opacity: 0.5;'}">
                <button class="chip-btn chip-1" onclick="reqBet('${p.id}', 1)">1</button>
                <button class="chip-btn chip-5" onclick="reqBet('${p.id}', 5)">5</button>
                <button class="chip-btn chip-10" onclick="reqBet('${p.id}', 10)">10</button>
                <button class="chip-btn chip-25" onclick="reqBet('${p.id}', 25)">25</button>
            </div>

            <div class="action-buttons" style="${isMe ? '' : 'pointer-events: none; opacity: 0.5;'}">
                <button class="action-btn-rect fold" onclick="reqFold('${p.id}')">ë‹¤ì´</button>
                <div class="input-group">
                    <input type="number" placeholder="ë² íŒ…" class="custom-input" 
                        ${isMe ? '' : 'disabled'}
                        onkeydown="if(event.key==='Enter') reqBetInput('${p.id}', this)">
                    <input type="number" placeholder="ëŒ€ì¶œ" class="custom-input" 
                        ${isMe ? '' : 'disabled'}
                        onkeydown="if(event.key==='Enter') reqLoan('${p.id}', this)">
                </div>
                <button class="action-btn-rect allin" onclick="reqAllIn('${p.id}')">ì˜¬ì¸</button>
            </div>
        `;
                container.appendChild(pDiv);
            });

            // 3. ë‹¨ê³„ ì´ë™ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const nextBtn = document.querySelector('.next-phase');
            const isMeReady = state.readyPlayers.includes(socket.id);

            if (state.roundIndex === state.rounds.length - 1 && state.phase === 'draw') {
                nextBtn.innerText = "ìŠ¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”";
                nextBtn.disabled = true;
                nextBtn.style.background = "#555";
            } else {
                nextBtn.disabled = false;
                if (activeCount === 0) {
                    nextBtn.innerText = "ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤";
                } else {
                    nextBtn.innerText = `ë‹¤ìŒ ë‹¨ê³„ ì´ë™ ë™ì˜ (${readyCount}/${activeCount})`;
                }
                nextBtn.style.background = isMeReady ? "#27ae60" : "#8e44ad";
            }
        }

        // === ì•¡ì…˜ ìš”ì²­ í•¨ìˆ˜ë“¤ (ì„œë²„ë¡œ ì „ì†¡) ===

        function reqAddPlayer() {
            const name = document.getElementById('newPlayerName').value.trim();
            const chips = parseInt(document.getElementById('initialChips').value);
            if (name) {
                localStorage.setItem('poker_name', name);

                // ì„œë²„ì— ì°¸ê°€ ìš”ì²­ ì‹œ UUIDë„ ê°™ì´ ë³´ëƒ„
                socket.emit('addPlayer', { name, initialChips: chips, uuid: MY_UUID });
                document.getElementById('newPlayerName').value = '';
            }
        }

        function reqBet(id, amount) {
            socket.emit('actionBet', { playerId: id, amount: amount });
        }

        function reqBetInput(id, input) {
            const amount = parseInt(input.value);
            if (!isNaN(amount) && amount > 0) {
                socket.emit('actionBet', { playerId: id, amount: amount });
                input.value = '';
            }
        }

        function reqAllIn(id) {
            if (confirm("ì •ë§ ì˜¬ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                socket.emit('actionAllIn', { playerId: id });
            }
        }

        function reqFold(id) {
            if (confirm("ë‹¤ì´(Fold) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                socket.emit('actionFold', { playerId: id });
            }
        }

        function reqLoan(id, input) {
            const amount = parseInt(input.value);
            if (!isNaN(amount) && amount > 0) {
                socket.emit('actionLoan', { playerId: id, amount: amount });
                input.value = '';
            }
        }

        function reqNextPhase() {
            socket.emit('nextPhase');
        }

        // === ìŠ¹ë¦¬ ì²˜ë¦¬ ëª¨ë‹¬ ê´€ë ¨ ===
        function openWinModal(id, name) {
            // ì‹¤ìˆ˜ ë°©ì§€ìš©: íŒŸì´ ìˆì–´ì•¼ ìŠ¹ë¦¬ ê°€ëŠ¥
            if (parseInt(document.getElementById('potAmount').innerText) === 0) return;

            currentWinnerId = id;
            document.getElementById('modalText').innerText = `${name} ë‹˜ì´ íŒŸì„ ê°€ì ¸ê°‘ë‹ˆê¹Œ?`;
            document.getElementById('modal').style.display = 'flex';
        }

        function reqConfirmWin() {
            if (currentWinnerId) {
                socket.emit('confirmWin', { playerId: currentWinnerId });
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentWinnerId = null;
        }

        // ... ê¸°ì¡´ í•¨ìˆ˜ë“¤ (reqNextPhase ë“±) ì•„ë˜ì— ì¶”ê°€

        // íŒ ì´ˆê¸°í™” ìš”ì²­
        function reqResetGame() {
            if (confirm("ëª¨ë“  í”Œë ˆì´ì–´ì˜ ì¹©ì„ ì²˜ìŒ ìƒíƒœë¡œ ë˜ëŒë¦¬ê³  íŒì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
                socket.emit('resetGame');
            }
        }

        function reqRemovePlayer(id) {
            if (confirm("ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì¹© ì •ë³´ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) {
                // ë‚˜ê°ˆ ë•Œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ë¦„ ì •ë³´ë„ ì§€ì›Œì„œ ìë™ ë¡œê·¸ì¸ì„ ë°©ì§€í•©ë‹ˆë‹¤.
                localStorage.removeItem('poker_name');
                socket.emit('removePlayer', { playerId: id, uuid: MY_UUID });

                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì„ í†µí•´ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™ (ì„ íƒ ì‚¬í•­)
                location.reload();
            }
        }

        // ì—°ê²°ë˜ìë§ˆì ì„œë²„ì— ë‚´ê°€ ëˆ„êµ¬ì˜€ëŠ”ì§€ ì•Œë¦¼ (ì´ë¯¸ ë°©ì— ìˆë‹¤ë©´ ê¶Œí•œ ë³µêµ¬ìš©)
        socket.on('connect', () => {
            const savedName = localStorage.getItem('poker_name'); // ì´ë¦„ì„ ì €ì¥í•´ë’€ë‹¤ë©´
            if (savedName) {
                socket.emit('addPlayer', { name: savedName, initialChips: 0, uuid: MY_UUID });
            }
        });

    </script>
</body>

</html>